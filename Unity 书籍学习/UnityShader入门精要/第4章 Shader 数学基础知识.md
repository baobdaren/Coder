# 第四章 Shader 数学基础知识

## 4.1 背景：农场游戏

## 4.2 笛卡尔坐标系

* 注意：OpenGL和DX使用不同的坐标系  
![4.1](./IMG/4章/OpenGL和DX使用了不同方向的坐标系.png)
* 左手坐标系和右手坐标系。  
左手和右手坐标系的xyz轴分别是大拇指，食指和中指。  
* Unity中的坐标系
  * 模型和世界空间，使用的是左手坐标系。
  * 观察空间，使用右手坐标系。
    ![2](./IMG/4章/观察空间坐标系.png)

## 4.3 点和矢量

* 矢量运算
  1. 矢量和标量的乘除法和加减法。  
     * 乘除法  
     ![2](./IMG/4章/矢量和标量的乘除法.png)  
     几何意义：对矢量进行缩放，或者改变方向  
     * 加减法  
     ![3](./IMG/4章/矢量的加减法.png)  
     矢量的加减法几何意义：a+b，把a的尾连接到b的头，然后从a的头到b的尾的矢量，就是其结果。  
     ![4](./IMG/4章/矢量加减法几何意义.png)

  2. 矢量的模
  就是矢量的长度

  3. 单位矢量
  指模长为1的矢量。单位矢量也称为**被归一化的矢量**，对于任何矢量，把他转换成单位矢量的过程称为归一化。

  4. 矢量的点积(内积)  
     * 公式：结果是一个标量  
       1. ![矢量的点积公式1](./IMG/4章/矢量的点积公式1.png)  
       2. ![矢量的点积公式2](./IMG/4章/矢量的点积公式2.png)  
     * 几何意义：  
       * 投影：如果一个长度任意的向量点乘一个单位矢量，结果是在单位向量上的投影  
       ![4](./IMG/4章/矢量点积的几何意义_投影.png)
       * 相似度
     * 性质：
       * 点积可结合标量乘法。
       * 点积可结合加减法。
       * 矢量自身的点积是模长的平方  

  5. 矢量的叉乘(外积)  
     * 公式：结果是一个标量，这个标量垂直于叉乘向量所在的平面，其方向为左手坐标系的z轴方向。  
     ![4](./IMG/4章/矢量叉乘公式.png)

  6. 矢量运算的使用举例
     * 如何判断一个位置在一个矢量的前方？
     * 如何判断一个位置在一个矢量的前方视角区域内？
     * 已知三角面三个顶点的坐标，如何判断当前面为正面？(如果看到的三点顺序为顺时针，则为反面)

  7. 注意：
     * 如果左手坐标系的z轴，就是x和y轴叉乘的结果。这就可以推出，叉乘结果的方向使用左手坐标系。叉乘不满足交换律，满足反交换律。
     * 一般比较两个矢量长度，我们使用各自的点乘来比较，而不是求出模长在比较，开更比较耗时。

## 4.4 矩阵

### 1. 矩阵运算

  1. 矩阵和标量的乘法：和每一个元素相乘，并且满足交换律。
  2. 矩阵和矩阵的乘法：矩阵相乘，必须满足列行相同。其结果是一个新的矩阵，新矩阵的元素M(i,j)，是第一个矩阵的i行和第二个矩阵的j列点乘。  
     * 矩阵不满足交换律
     * 矩阵满足结合律

### 2. 特殊矩阵

  1. 方块矩阵：方正
     * 对角矩阵：除了对角元素外，均为0，则称为对角矩阵。
     * 单位矩阵：对角元素都为0的对角矩阵。任何矩阵乘以单位矩阵都不变。MI=IM=M。
     * 转置矩阵： 把原矩阵的第i行变成第i列，局势转置矩阵。矩阵相乘结果的转置，等于他们转置结果的交换相乘。  
     ![4](./IMG/4章/矩阵转置相乘.png)
  2. 逆矩阵：![4](./IMG/4章/逆矩阵.png)
     * 只有方正才有逆矩阵，并非所有的矩阵都有逆矩阵，如只有一个0的矩阵。
     * 如果一个矩阵有对应的逆矩阵，则这个矩阵是可逆的或非奇异的。反之，我们称该矩阵不可逆或奇异的。
     * 当矩阵的行列式为0时，这个矩阵就是可逆的，求行列式使用内置函数即可。
     * 性质：  
        1. 逆矩阵的逆矩阵是原矩阵。
        2. 单位矩阵的逆矩阵是单位矩阵。
        3. 转置矩阵的逆矩阵=逆矩阵的转置矩阵
        4. 矩阵相乘后的逆矩阵 和 逆矩阵相乘  
        ![2](./IMG/4章/逆矩阵性质.png)
        5. 逆矩阵具有几何意义：  
        ![2](./IMG/4章/逆矩阵的几何意义.png)
        6. 正交矩阵：  
        如果矩阵满足下列公式  
        ![2](./IMG/4章/正交矩阵.png)  
        则称M矩阵为一个正交的矩阵。  
        如果一个矩阵正交，那么从几何意义上说，其转置矩阵是原矩阵变换的反向变换。  
        在实际中我们经常需要获得变换的反向变换，而逆矩阵的求解往往计算量很大，但是转置矩阵却非常容易。如果我们知道这个矩阵是正交的，那么我们就可以用它的逆矩阵作为反向变换矩阵。  

## 4.5 矩阵的几何意义——变换

* 分解基础变换矩阵  
![4](./IMG/4章/分解变换矩阵.png)  
其中M₃₃表示旋转和缩放。  
t表示平移  
0表示0矩阵。  
右下角元素就是标量1  
* 平移矩阵  
![4](./IMG/4章/平移矩阵.png)
* 缩放矩阵  
![4](./IMG/4章/缩放矩阵.png)
缩放矩阵一般不是正交矩阵，所以逆变换使用矩阵是原矩阵缩放系数的倒数。  
如果眼沿着某一个指定的方向缩放，则需要复合变换。
* 旋转矩阵  
![4](./IMG/4章/绕x轴旋转的矩阵.png)  
![4](./IMG/4章/绕y轴旋转的矩阵.png)  
![4](./IMG/4章/绕z轴旋转的矩阵.png)  
旋转矩阵的逆矩阵是通过旋转相反的角度得到的变换矩阵。  
旋转矩阵是正交矩阵，而且多个矩阵的串联同样是正交的。
* 复合变换  
![复合变换公式](./IMG/4章/复合变换公式.png)  
由于我们使用的是列矩阵，所以阅读顺序是从右往左。即先进行缩放变换，再进行旋转变换，最后进行平移变换。这是绝大多情况下约定的顺序。矩阵乘法不满足结合律，不同的顺序结果可能不同。  
unity的旋转顺序是zxy

## 4.4 坐标空间

* 坐标空间变换  
abc分别代表内部坐标系在父空间坐标系的坐标  
![1](./IMG/4章/坐标空间变换1.png)  
![2](./IMG/4章/坐标空间变换2.png)  
由于上面的公式存在加法变化，而3X3矩阵不能表示平移，所以我们将它扩展到齐次坐标空间中。  
![2](./IMG/4章/坐标空间变换3.png)  
* 顶点的坐标空间变换过程。  
  * 模型空间

  * 世界空间  
  下面是一个空间变换的举例（模型空间到世界空间，带入的坐标是模型坐标中的一个位置）：
  ![2](./IMG/4章/顶点的坐标空间变换举例.png)  
  上例中最后得到的变换矩阵，可以用来计算所有模型空间的位置，在世界空间的位置。  
   问：为什么这个变换矩阵是根据模型的变换得到的，却能够计算模型坐标在世界坐标中位置？  
   答：我们可以看作模型一开始被放在世界坐标远点，这时候我们得到了局部坐标的世界坐标位置，又因为模型变换时所有局部左边进行着相同的变换，所以所有的局部坐标都可以用这个变换来算出变换后的世界坐标。简而言之——坐标空间的变换也就是，坐标空间中每个点的变换。

  * 观察空间  
  观察空间也就是摄像机空间。
  我们需要把世界坐标中的位置转换到观察空间，转换道理和模型空间到世界空间相同。  
  需要注意的是，Unity中观察空间使用的右手坐标系，所以转换完成后对Z轴进行-1倍的缩放。  

  * 剪裁空间
   也被称为齐次剪裁空间。从观察空间转换到剪裁空间的矩阵叫剪裁矩阵。这块空间由视锥体觉得。视锥体有6个面组成。视锥体有两种类型，他们涉及两种投影：正交投影和透视投影。  
   ![两种视锥体](./IMG/4章/两种视锥体.png)
   透视摄像机参数
   ![透视投影矩阵参数](./IMG/4章/透视摄像机的参数.png)  
   1. 透视投影矩阵  
   ![透视投影矩阵](./IMG/4章/透视投影矩阵.png)
   aspect是宽高比例  
   透视投影矩阵的推导在谈论之外  
   对一个点(x,y,z)进行透视投影计算。  
   ![透视投影矩阵](./IMG/4章/透视投影计算.png)  
   有结果可以看出，这个缩放矩阵就是对xyz进行了不同程度的缩放（当然，对z轴还进行了一个平移），缩放的目的是方便剪裁。  
   使用以下公式确定一个顶点在视锥体内？  
   ![剪裁判断](./IMG/4章/剪裁判断条件.png)  
   任何不满足上述条件的图元都要被剪裁或剔除  

   2. 正交投影矩阵  
   ![剪裁判断](./IMG/4章/正交投影矩阵.png)  
   对一个点(x,y,z)进行正交投影计算。
   ![正交投影矩阵的示例运算](./IMG/4章/正交投影计算.png)  
   上图和透视投影矩阵计算相比，其结果的最后(4,1)元素不相同，原因是透视投影矩阵最后一行是[0,0,-1,0]，而正交投影矩阵的最后一行是[0,0,0,1]。这样选择主要是为齐次除法做准备，后面会谈到。  
   透视投影的剪裁条件和正交投影相同，这也是选择投影矩阵的缘由。
  * 屏幕空间  
  完成了投影之后，就开始进行真正的剪裁了。也就是说，我们要把视锥体投影到屏幕空间。这一步之后我们会得到真正的像素位置，而不是虚拟三维坐标。  
  由于屏幕空间是一个2D坐标，我们必须把顶点从剪裁空间投影到屏幕空间，来生成对应的2D坐标，这个过程有两个步骤。  
  1. 进行标准齐次除法，又称透视除法。  
      用w分量去除以x,y,z分量。在OpenGL中把这一步得到的坐标叫归一化的设备坐标（NDC）。即变换到一个立方体内部。在OpenGL中这个立方体x，y，z分量的范围都是[-1，1]，而Direct的API中范围是[0，1]。在unity中使用OpenGL的齐次剪裁空间。
      ![齐次除法](./IMG/4章/齐次除法1.png)  
      而对于正交投影来说，他的剪裁空间已经是一个立方体了，而且由于正交投影矩阵变换后，w分量为1，所以齐次除法不会对其坐标产生影响。  
      ![齐次除法](./IMG/4章/齐次除法2.png)  
  2. 映射输出  
  经过齐次除法后，正交投影和透视投影的视锥体都变换到一个相同的立方体内部。现在我们可以根据变换后的x和y坐标来映射输出窗口的对应像素坐标，这个过程就是一个缩放过程。这个过程由unity完成。顶点着色器只需要把顶点转换到剪裁空间即可。  
  齐次除法和屏幕映射的过程可以总结为下列公式：  
  ![齐次剪裁和屏幕映射总结公式](./IMG/4章/齐次剪裁和屏幕映射总结公式.png)  
  举例使用上述公式（从剪裁空间到屏幕）  
  剪裁空间位置  
  ![1](./IMG/4章/示例剪裁空间到屏幕1.png)  
  到屏幕空间的计算  
  ![1](./IMG/4章/示例剪裁空间到屏幕2.png)  
  最后我们得到的坐标就是该点在屏幕上的坐标。
  ![总结图](./IMG/4章/从模型空间到屏幕的重要空间的转换总结.png)  
  上图介绍了从模型空间到屏幕空间的重要空间的转换。（还有其他空间，这里不做介绍）  

## 4.7 法线变换  

这一节好像没啥东西，不过要知道矩阵乘法不满足交换律，满足结合律。
其中有一些计算，缘由是如果使用同一矩阵来变换，法线可能在缩放后不再满足。  

## 4.8 Unity Shader 的内置变量

* 变换矩阵  
![内置的变换矩阵](./IMG/4章/Unity内置变换矩阵.png)
如果一个变换只包含旋转，那么它一定是个正交矩阵。如果它包含了旋转和统一缩放k，那么把它除以k则也是一个正交矩阵。而正交矩阵的转置就是其逆矩阵。  
Unity内置矩阵是按照列存储的  
* 摄像机和屏幕参数  
![内置的变换矩阵](./IMG/4章/Unity内置摄像机和屏幕参数1.png)
![内置的变换矩阵](./IMG/4章/Unity内置摄像机和屏幕参数2.png)

## 4.9 答疑解惑章节

* CG中的矢量类型和矩阵类型  
在CG语言中，矩阵类型有float3x3，float4x4。而对于float3和float4，我们即可以把它们当成一个矢量，也可以当作是1xn或nx1的矩阵。这取决于运算的种类和他们在运算中的位置。  
在CG语言中，对于矩阵的读写都是行优先的方式。  
Matrix4x4则是使用列优先的方式读写。  
