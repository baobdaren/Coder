# 面试必问之-如何减少DrawCall

* 什么是DrawCall？
    就是CPU对底层图形接口的调用。

* fragment是啥？
    潜在像素，可能称为像素。

* batching是啥？
    将批处理之前需要很多次调用（drawcall）的问题合并，之后只需调用一次底层图形接口就行。但有一些不足。

* 内存分配？

## 优化方面

GPU CPU 内存

### CPU方面的优化

* DrawCalls
    如果很多个“相同”的物体，每一次CPU调用GPU绘制会花费一些时间，但是对于GPU来说工作都是一样的。所以主要是要解放CPU调用的开销。所以针对drawcall我们主要的思路就是尽量减少渲染次数，多个物体最好一起渲染。

    1. 使用Draw Call Batching，也就是描绘调用批处理。
    2. 通过把纹理打包成图集来减少材质使用。
    3. 减少反光阴影，那会使物体多次渲染。

* Draw Call Batching

    两个使用不同材质的物体，不能被合批。这其实是为了保证纹理相同。
    将不同纹理打包到同一图集，这样可以只用一个材质。

  * 静态批处理  
  只要这些物体不移动，并且拥有相同的材质，静态批处理就允许引擎对任意大小的进行批处理操作。  
  再inspector面板中选中static。  
  
  * 动态批处理  
  动态批处理有很多限制。其再设置中允许动态批处理后，游戏运行时会自发进行。  
  如下有限制：  
    1. 顶点数限制：900
    2. 着色器使用更多如顶点，法向等，会使顶点数限制下降
    3. 有一些缩放比例会导致合批失败（含有奇数个负缩放坐标）
    4. 统一缩放和非统一缩放不会合批
    5. 不同材质实例不合批
    6. 含有额外属性的，如：lightmap偏移和缩放系数。所以有lightmap的物体不合批
    7. 多通道shader会妨碍批处理

  * Instancing材质
  将材质选项Enable GPU Instancing打开（需要shader支持）  
  主要用于草，房屋，树等大量重复的小网格物体。但是不支持皮肤网格  
  这种方法下修改颜色需要使用

  * Instancing材质
  将材质选项`Enable GPU Instancing`打开，即可再运行时合并使用该材质的实例。一般用于树木，房屋，草等大量重复小网格物体。顶点大于900，该方法比动态合批要好，动态合批也要消耗cpu计算。  
  使用条件：
    1. 兼容平台和API。
    2. 形同的mesh和material
    3. Shader支持GPU Instancine

## 回答：

静态合批和动态合批和instancing材质，使用图集。  
减少实时光照和阴影效果。可以使用光照贴图。