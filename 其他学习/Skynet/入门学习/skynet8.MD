# å…« Multicast ç»„æ’­

## ä»‹ç»

å¼•ç”¨æ¨¡å—`skynet.multicast`åˆ™å¯ä»¥ä½¿ç”¨skynetçš„ç»„æ’­æ–¹æ¡ˆã€‚å¯ä»¥è‡ªç”±åˆ›å»ºä¸€ä¸ªé¢‘é“ï¼Œå‘å…¶ä¸­æŠ•é€’ä»»æ„è¯¦ç»†ï¼Œè®¢é˜…è€…åˆ™å¯ä»¥æ¥æ”¶ã€‚  

ä½ å¯ä»¥ä½¿ç”¨`local channel = skynet.multicast.new`åˆ›å»ºä¸€ä¸ªæ–°çš„é¢‘é“ï¼Œä¹Ÿå¯ä»¥æä¾›å·²åˆ›å»ºçš„é¢‘é“çš„idæ¥ç»‘å®šè¿™ä¸ªé¢‘é“ï¼ˆè·å¾—å‘é€æƒï¼‰ã€‚  

é€šå¸¸ç”±ä¸€ä¸ªæœåŠ¡åˆ›å»ºé¢‘é“ï¼Œç„¶åé€šçŸ¥å…¶ä»–æœåŠ¡è¯¥idå¯¹è±¡ï¼Œå…¶ä»–æœåŠ¡åˆ™ä½¿ç”¨è¯¥idç»‘å®šã€‚  
`channel.dispatch = func(session, address, ...)`ï¼šé¢‘é“å¤„ç†å‡½æ•°ã€‚  
`channel:publish(...)`ï¼šå‘ä¸€ä¸ªé¢‘é“å‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯å¯ä»¥æ˜¯ä»»æ„çš„åˆæ³•luaå€¼ã€‚  
`channel:subscribe()`ï¼šç»‘å®šä¸€ä¸ªé¢‘é“åï¼Œé»˜è®¤æ˜¯ä¸æ¥æ”¶æ¶ˆæ¯çš„ï¼ˆä¸è®¢é˜…ï¼Ÿï¼Ÿï¼Ÿï¼‰ï¼ˆä¹Ÿè®¸ä½ åªæƒ³å‘é€æ¶ˆæ¯ï¼‰ã€‚åˆ™ä½¿ç”¨è¯¥æ–¹æ³•è®¢é˜…å®ƒã€‚  
`channel:unsubscribe()`ï¼šå–æ¶ˆè®¢é˜…ã€‚  
`channel:delete()`ï¼šåˆ é™¤é¢‘é“ã€‚å‘å¸ƒå’Œè®¢é˜…å·²åˆ é™¤çš„é¢‘é“ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿä¸ä¼šæ¥æ”¶åˆ°æ¶ˆæ¯ã€‚channelçš„idæ°¸ä¸å¤ç”¨ï¼Œæ‰€ä»¥å¤šæ¬¡è°ƒç”¨ä¸ä¼šç”±é—®é¢˜ã€‚  

> åœ¨ä½¿ç”¨æ—¶æ³¨æ„ï¼Œé¦–æ¬¡åˆ›å»ºé¢‘é“æ—¶ï¼Œæš‚æ—¶æ²¡æœ‰æ³¨æ„åˆ°æœ‰ç»‘å®šdispatchå¤„ç†å‡½æ•°çš„æ–¹å¼ï¼Œèµ‹å€¼ä¹Ÿä¸è¡Œã€‚æ‰€ä»¥ï¼Œè¦æ·»åŠ dispatchå‡½æ•°ï¼Œéœ€è¦å†newï¼Œç„¶ååœ¨å‚æ•°åˆ—è¡¨ä¸­èµ‹å€¼dispatchã€‚  

## æ¡ˆä¾‹

ä¸‹é¢æ˜¯è‡ªå·±å†™çš„ä¸€ä¸ªç®€å•çš„æˆ¿é—´æ¡ˆä¾‹ï¼Œå®ç°äº†ç©å®¶åˆ©ç”¨ç»„æ’­è·å–æ¸¸æˆå¼€å§‹ä¿¡æ¯ã€‚å’Œå®é™…ä½¿ç”¨ä¸åŒï¼Œæˆ‘ä»¬ä¸»è¦ç¤ºä¾‹å¹¿æ’­èƒ½åŠ›ã€‚  

* æˆ¿é—´æœåŠ¡

```lua
-- ç»„æ’­
local this = {}
local  skynet = require "skynet"
local multicast = require "skynet.multicast"
local homechannel = nil  -- æˆ¿é—´çš„é¢‘é“

require "skynet.manager"

skynet.start(function ()
    skynet.register(".home")  -- ç»™æˆ¿é—´æœåŠ¡æ³¨å†Œåˆ«å

    skynet.dispatch("lua", function(session, address, ask, args)
        if ask == "getchannel" then -- è¿”å›å¯¹æˆ¿é—´æœåŠ¡ç»„æ’­é¢‘é“idçš„è¯·æ±‚
            skynet.retpack(this.getchannel())
        end
    end)

    homechannel = multicast.new()  -- åˆ›å»ºé¢‘é“å®ä¾‹

    skynet.timeout(10,function () -- åˆ›å»ºä¸€ä¸ªç©å®¶
        skynet.newservice("test8_1", "ç–¾é£è±ª")
    end)
    skynet.timeout(20,function () -- åˆ›å»ºä¸€ä¸ªç©å®¶
        skynet.newservice("test8_1", "æ³½æ‹‰æ–¯")
    end)
    skynet.timeout(90,function () -- åˆ›å»ºä¸€ä¸ªç©å®¶
        skynet.newservice("test8_1", "é£ä¹‹å­")
    end)

    this.gamestart(3) -- æ¯ç§’å‘é€å€’è®¡æ—¶
end)

function this.getchannel()
    return homechannel.channel
end

function this.gamestart(lt)
    if lt < 0 then
        return
    end
    skynet.timeout(100,function ()
        homechannel:publish("è¿˜æœ‰".. tostring(lt) .."S å¼€å§‹æ¸¸æˆ")
        this.gamestart(lt-1)
    end)
end
```

* ç©å®¶æœåŠ¡

```lua
local skynet = require "skynet"
local mc = require "compat10.multicast"
require "skynet.manager"
local playername = ...

skynet.start(function ()
    local s = skynet.localname(".home") -- è·å–æˆ¿é—´æœåŠ¡ åœ°å€
    local r = {skynet.call(s,"lua","getchannel")} -- è¯·æ±‚æˆ¿é—´é¢‘é“çš„id
    local channelid = r[1]

    local channel = mc.new{
        channel = channelid,
        dispatch = function (add, sess, msg, ...)
            skynet.error(playername ,"æ¥æ”¶åˆ°æ¶ˆæ¯-",msg)
        end
    }
    channel:subscribe()
    channel:publish(playername .. "è¿›å…¥äº†æˆ¿é—´")
end)
```

* è¿è¡Œç»“æœ

```lua
-- [:01000002] KILL self
-- [:0100000b] LAUNCH snlua test8_1 ç–¾é£è±ª
-- [:0100000b] ç–¾é£è±ª æ¥æ”¶åˆ°æ¶ˆæ¯- ç–¾é£è±ªè¿›å…¥äº†æˆ¿é—´
-- [:0100000c] LAUNCH snlua test8_1 æ³½æ‹‰æ–¯
-- [:0100000c] æ³½æ‹‰æ–¯ æ¥æ”¶åˆ°æ¶ˆæ¯- æ³½æ‹‰æ–¯è¿›å…¥äº†æˆ¿é—´
-- [:0100000b] ç–¾é£è±ª æ¥æ”¶åˆ°æ¶ˆæ¯- æ³½æ‹‰æ–¯è¿›å…¥äº†æˆ¿é—´
-- [:0100000d] LAUNCH snlua test8_1 é£ä¹‹å­
-- [:0100000d] é£ä¹‹å­ æ¥æ”¶åˆ°æ¶ˆæ¯- é£ä¹‹å­è¿›å…¥äº†æˆ¿é—´
-- [:0100000c] æ³½æ‹‰æ–¯ æ¥æ”¶åˆ°æ¶ˆæ¯- é£ä¹‹å­è¿›å…¥äº†æˆ¿é—´
-- [:0100000b] ç–¾é£è±ª æ¥æ”¶åˆ°æ¶ˆæ¯- é£ä¹‹å­è¿›å…¥äº†æˆ¿é—´
-- [:0100000c] æ³½æ‹‰æ–¯ æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰3S å¼€å§‹æ¸¸æˆ
-- [:0100000d] é£ä¹‹å­ æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰3S å¼€å§‹æ¸¸æˆ
-- [:0100000b] ç–¾é£è±ª æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰3S å¼€å§‹æ¸¸æˆ
-- [:0100000c] æ³½æ‹‰æ–¯ æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰2S å¼€å§‹æ¸¸æˆ
-- [:0100000d] é£ä¹‹å­ æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰2S å¼€å§‹æ¸¸æˆ
-- [:0100000b] ç–¾é£è±ª æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰2S å¼€å§‹æ¸¸æˆ
-- [:0100000c] æ³½æ‹‰æ–¯ æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰1S å¼€å§‹æ¸¸æˆ
-- [:0100000d] é£ä¹‹å­ æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰1S å¼€å§‹æ¸¸æˆ
-- [:0100000b] ç–¾é£è±ª æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰1S å¼€å§‹æ¸¸æˆ
-- [:0100000c] æ³½æ‹‰æ–¯ æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰0S å¼€å§‹æ¸¸æˆ
-- [:0100000d] é£ä¹‹å­ æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰0S å¼€å§‹æ¸¸æˆ
-- [:0100000b] ç–¾é£è±ª æ¥æ”¶åˆ°æ¶ˆæ¯- è¿˜æœ‰0S å¼€å§‹æ¸¸æˆ
```

å¯ä»¥çœ‹åˆ°æ‰€æœ‰è®¢é˜…è€…éƒ½å¯ä»¥æ¥æ”¶åˆ°å…¶ä»–æœåŠ¡å‘å¸ƒçš„æ¶ˆæ¯ã€‚  

å¤šèŠ‚ç‚¹ä¸‹éœ€è¦è‡ªå·±å®ç°ç»„æ’­ğŸ™‚ã€‚  
